<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ご登録フォーム</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" crossorigin="anonymous" />
</head>
<body>
  <div id="formSection" style="display:none;">
    <p class="text-center mt-3">【ご登録フォーム】</p>
    <form class="w-75 mx-auto" id="memberForm">
      <p class="mt-3">性別</p>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="gender" id="male" value="男性" required />
        <label class="form-check-label" for="male">男性</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="gender" id="female" value="女性" />
        <label class="form-check-label" for="female">女性</label>
      </div>

      <p class="mt-3">年代</p>
      <select class="form-control" name="generation" id="generationSelect" required>
        <option value="" disabled selected>選択してください</option>
      </select>

      <p class="mt-3">エリア</p>
      <select class="form-control" name="area" id="areaSelect" required>
        <option value="" disabled selected>選択してください</option>
      </select>

      <input type="submit" class="btn btn-primary mt-4" value="送信" />
    </form>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>

  <script>
    const liffId = "2007879229-w3ZOJvm6";
    const gasApiUrl = "https://script.google.com/macros/s/XXXXXXXXXXX/exec"; // GASで用意したユーザー存在確認API
    const gasPostUrl = "https://script.google.com/macros/s/YYYYYYYYYYY/exec"; // GASのPOST登録先

    const populateDropdowns = () => {
      const generationSelect = document.getElementById('generationSelect');
      const areaSelect = document.getElementById('areaSelect');

      [10, 20, 30, 40, 50, 60, 70, 80, 90].forEach(gen => {
        const option = document.createElement('option');
        option.value = `${gen}代`;
        option.textContent = `${gen}代`;
        generationSelect.appendChild(option);
      });

      const prefectures = [
        "北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県",
        "茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県",
        "新潟県","富山県","石川県","福井県","山梨県","長野県",
        "岐阜県","静岡県","愛知県","三重県",
        "滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県",
        "鳥取県","島根県","岡山県","広島県","山口県",
        "徳島県","香川県","愛媛県","高知県",
        "福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"
      ];

      prefectures.forEach(pref => {
        const option = document.createElement('option');
        option.value = pref;
        option.textContent = pref;
        areaSelect.appendChild(option);
      });
    };

    const checkUserExists = async (lineId) => {
      const res = await fetch(`${gasApiUrl}?line_id=${lineId}`);
      const json = await res.json();
      return json.exists;
    };

    const registerUserToSheet = (data) => {
      fetch(gasPostUrl, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams(data),
      });
    };

    const sendTextToLine = (text) => {
      liff.sendMessages([{ type: 'text', text }])
        .then(() => liff.closeWindow())
        .catch(err => {
          console.error("LINE送信失敗", err);
          alert("LINE送信失敗: " + err);
        });
    };

    window.onload = async () => {
      await liff.init({ liffId });

      if (!liff.isLoggedIn()) {
        liff.login({ botPrompt: 'normal' }); // ← 友だち追加
        return;
      }

      const profile = await liff.getProfile();
      const lineId = profile.userId;
      const displayName = profile.displayName;

      const exists = await checkUserExists(lineId);

      if (exists) {
        liff.openWindow({ url: "https://line.me/R/oaMessage/@xxxxxxx", external: true });
      } else {
        populateDropdowns();
        document.getElementById("formSection").style.display = "block";

        document.getElementById('memberForm').addEventListener('submit', e => {
          e.preventDefault();

          const gender = document.querySelector('input[name="gender"]:checked')?.value;
          const generation = document.getElementById('generationSelect').value;
          const area = document.getElementById('areaSelect').value;

          const formData = {
            line_user_id: lineId,
            display_name: displayName,
            gender,
            age_range: generation,
            area
          };

          registerUserToSheet(formData);
          sendTextToLine(`${displayName}さん、登録ありがとうございます！`);
        });
      }
    };
  </script>
</body>
</html>
