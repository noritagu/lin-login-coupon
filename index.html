<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ご登録フォーム</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" crossorigin="anonymous" />
</head>
<body>
  <p class="text-center mt-3">【ご登録フォーム】</p>
  <form class="w-75 mx-auto" id="memberForm">
    <!-- 性別 -->
    <p class="mt-3">性別</p>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="gender" id="male" value="男性" required />
      <label class="form-check-label" for="male">男性</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="gender" id="female" value="女性" />
      <label class="form-check-label" for="female">女性</label>
    </div>

    <!-- 年代 -->
    <p class="mt-3">年代</p>
    <select class="form-control" name="generation" id="generationSelect" required>
      <option value="" disabled selected>選択してください</option>
    </select>

    <!-- エリア -->
    <p class="mt-3">エリア</p>
    <select class="form-control" name="area" id="areaSelect" required>
      <option value="" disabled selected>選択してください</option>
    </select>

    <!-- 送信ボタン -->
    <input type="submit" class="btn btn-primary mt-4" value="送信" />
  </form>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>

  <script>
    const liffId = "2007879229-w3ZOJvm6"; // 実際のLIFF IDに置き換え済み

    // 年代と都道府県のリストを動的に追加
    window.addEventListener('DOMContentLoaded', () => {
      const generationSelect = document.getElementById('generationSelect');
      const areaSelect = document.getElementById('areaSelect');

      [10, 20, 30, 40, 50, 60, 70, 80, 90].forEach(gen => {
        const option = document.createElement('option');
        option.value = `${gen}代`;
        option.textContent = `${gen}代`;
        generationSelect.appendChild(option);
      });

      const prefectures = [
        "北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県",
        "茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県",
        "新潟県","富山県","石川県","福井県","山梨県","長野県",
        "岐阜県","静岡県","愛知県","三重県",
        "滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県",
        "鳥取県","島根県","岡山県","広島県","山口県",
        "徳島県","香川県","愛媛県","高知県",
        "福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"
      ];

      prefectures.forEach(pref => {
        const option = document.createElement('option');
        option.value = pref;
        option.textContent = pref;
        areaSelect.appendChild(option);
      });
    });

    // LIFF初期化とログイン
    window.onload = async () => {
      try {
        await liff.init({ liffId });
        if (!liff.isLoggedIn()) {
          liff.login({
            scope: 'profile openid email',
            botPrompt: 'normal' // ← 友だち追加画面を表示するために必要
          });
        }
      } catch (error) {
        console.error("LIFF init error", error);
        alert("LIFF初期化に失敗しました");
      }
    };

    // Google Apps Scriptへデータ送信
    function sendToGoogleSheet(data) {
      fetch("https://script.google.com/macros/s/AKfycbySUAiSOrWp964fhslT3dejPekpODSbHTxN21ALekku9YQUAIo6vdndq_rdv3238z8bFQ/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams(data),
      })
      .then(() => console.log("送信成功"))
      .catch(err => console.error("送信失敗", err));
    }

    // LINEメッセージ送信
    function sendTextToLine(text) {
      liff.sendMessages([{ type: 'text', text }])
        .then(() => {
          console.log("LINEに送信成功");
          liff.closeWindow();
        })
        .catch(err => {
          console.error("LINE送信失敗", err);
          alert("LINE送信失敗: " + err);
        });
    }

    // フォーム送信イベント
    document.getElementById('memberForm').addEventListener('submit', e => {
      e.preventDefault();

      const gender = document.querySelector('input[name="gender"]:checked')?.value;
      const generation = document.querySelector('select[name="generation"]').value;
      const area = document.querySelector('select[name="area"]').value;

      const formData = { gender, generation, area };
      const message = `${gender},${generation},${area}`;

      sendToGoogleSheet(formData);
      sendTextToLine(message);
    });
  </script>
</body>
</html>
